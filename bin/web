#!/usr/bin/env node
// Deploying to Zone through FTP loses the node_modules/root symlink.
var Fs = require("fs")
var ROOT_LINK = __dirname + "/../node_modules/root"
if (!Fs.existsSync(ROOT_LINK)) Fs.symlinkSync("..", ROOT_LINK)

var Url = require("url")
var Http = require("http")
var Express = require("express")
var PORT = process.env.PORT || 3000
var PUBLIC_DIR = __dirname + "/../public"

var app = module.exports = Express()

app.set("view engine", "jade")
app.locals.pretty = false
app.locals.require = require
app.locals.basedir = app.get("views")

app.use(Express.static(PUBLIC_DIR))
if (process.env.ENV == "development") app.use(require("morgan")("dev"))
app.use((req, res, next) => { res.locals.req = req; next() })
app.use(require("root/lib/middleware/i18n_middleware"))
app.use(require("root/controllers/home_controller").router)

app.use(function(req, res, next) {
  res.sendFile("app.html", {root: PUBLIC_DIR})
})

if (module.parent) return

Http.createServer(app).listen(PORT, function() {
  var addr = this.address()

  console.log("Listening on %s.", typeof addr == "string" ? addr : Url.format({
    protocol: "http", hostname: addr.address, port: addr.port
  }))
})
